CKEDITOR.dialog.add("link",function(r){function y(a){return a.replace(/'/g,"\\$&")}function A(a){var e,b=s.params,c,d;e=[s.name,"("];for(var f=0;f<b.length;f++){c=b[f].toLowerCase();d=a[c];f>0&&e.push(",");e.push("'",d?y(encodeURIComponent(a[c])):"","'")}e.push(")");return e.join("")}function B(a){for(var e,b=a.length,c=[],d=0;d<b;d++){e=a.charCodeAt(d);c.push(e)}return"String.fromCharCode("+c.join(",")+")"}function C(a){return(a=a.getAttribute("class"))?a.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,
""):""}var D=CKEDITOR.plugins.link,z=function(){var a=this.getDialog(),e=a.getContentElement("target","popupFeatures");a=a.getContentElement("target","linkTargetName");var b=this.getValue();if(e&&a){e=e.getElement();e.hide();a.setValue("");switch(b){case "frame":a.setLabel(r.lang.link.targetFrameName);a.getElement().show();break;case "popup":e.show();a.setLabel(r.lang.link.targetPopupName);a.getElement().show();break;default:a.setValue(b);a.getElement().hide()}}},E=/^javascript:/,F=/^mailto:([^?]+)(?:\?(.+))?$/,
G=/subject=([^;?:@&=$,\/]*)/,H=/body=([^;?:@&=$,\/]*)/,I=/^#(.*)$/,J=/^((?:http|https|ftp|news):\/\/)?(.*)$/,K=/^(_(?:self|top|parent|blank))$/,L=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,M=/^javascript:([^(]+)\(([^)]+)\)$/,N=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,O=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,P=function(a,e){var b=e&&(e.data("cke-saved-href")||e.getAttribute("href"))||"",c,d,f=
{};if(b.match(E))if(t=="encode")b=b.replace(L,function(j,l,m){return"mailto:"+String.fromCharCode.apply(String,l.split(","))+(m&&m.replace(/\\'/g,"'"))});else t&&b.replace(M,function(j,l,m){if(l==s.name){f.type="email";j=f.email={};l=/(^')|('$)/g;m=m.match(/[^,\s]+/g);for(var u=m.length,v,w,x=0;x<u;x++){v=decodeURIComponent;w=m[x].replace(l,"").replace(/\\'/g,"'");w=v(w);v=s.params[x].toLowerCase();j[v]=w}j.address=[j.name,j.domain].join("@")}});if(!f.type)if(c=b.match(I)){f.type="anchor";f.anchor=
{};f.anchor.name=f.anchor.id=c[1]}else if(c=b.match(F)){d=b.match(G);b=b.match(H);f.type="email";var h=f.email={};h.address=c[1];d&&(h.subject=decodeURIComponent(d[1]));b&&(h.body=decodeURIComponent(b[1]))}else if(b&&(d=b.match(J))){f.type="url";f.url={};f.url.protocol=d[1];f.url.url=d[2]}else f.type="url";if(e){c=e.getAttribute("target");f.target={};f.adv={};if(c)if(c.match(K))f.target.type=f.target.name=c;else{f.target.type="frame";f.target.name=c}else if(c=(c=e.data("cke-pa-onclick")||e.getAttribute("onclick"))&&
c.match(N)){f.target.type="popup";for(f.target.name=c[1];b=O.exec(c[2]);)if((b[2]=="yes"||b[2]=="1")&&!(b[1]in{height:1,width:1,top:1,left:1}))f.target[b[1]]=true;else if(isFinite(b[2]))f.target[b[1]]=b[2]}c=function(j,l){var m=e.getAttribute(l);if(m!==null)f.adv[j]=m||""};c("advId","id");c("advLangDir","dir");c("advAccessKey","accessKey");f.adv.advName=e.data("cke-saved-name")||e.getAttribute("name")||"";c("advLangCode","lang");c("advTabIndex","tabindex");c("advTitle","title");c("advContentType",
"type");CKEDITOR.plugins.link.synAnchorSelector?f.adv.advCSSClasses=C(e):c("advCSSClasses","class");c("advCharset","charset");c("advStyles","style");c("advRel","rel")}c=f.anchors=[];if(CKEDITOR.plugins.link.emptyAnchorFix){var i=a.document.getElementsByTag("a");b=0;for(d=i.count();b<d;b++){h=i.getItem(b);if(h.data("cke-saved-name")||h.hasAttribute("name"))c.push({name:h.data("cke-saved-name")||h.getAttribute("name"),id:h.getAttribute("id")})}}else{i=new CKEDITOR.dom.nodeList(a.document.$.anchors);
b=0;for(d=i.count();b<d;b++){h=i.getItem(b);c[b]={name:h.getAttribute("name"),id:h.getAttribute("id")}}}if(CKEDITOR.plugins.link.fakeAnchor){i=a.document.getElementsByTag("img");b=0;for(d=i.count();b<d;b++)if(h=CKEDITOR.plugins.link.tryRestoreFakeAnchor(a,i.getItem(b)))c.push({name:h.getAttribute("name"),id:h.getAttribute("id")})}this._.selectedElement=e;return f},n=function(a){if(a.target)this.setValue(a.target[this.id]||"")},o=function(a){if(a.adv)this.setValue(a.adv[this.id]||"")},p=function(a){a.target||
(a.target={});a.target[this.id]=this.getValue()||""},q=function(a){a.adv||(a.adv={});a.adv[this.id]=this.getValue()||""},t=r.config.emailProtection||"";if(t&&t!="encode"){var s={};t.replace(/^([^(]+)\(([^)]+)\)$/,function(a,e,b){s.name=e;s.params=[];b.replace(/[^,\s]+/g,function(c){s.params.push(c)})})}var k=r.lang.common,g=r.lang.link;return{title:g.title,minWidth:350,minHeight:230,contents:[{id:"info",label:g.info,title:g.info,elements:[{id:"linkType",type:"select",label:g.type,"default":"url",
items:[[g.toUrl,"url"],[g.toAnchor,"anchor"],[g.toEmail,"email"]],onChange:function(){var a=this.getDialog(),e=["urlOptions","anchorOptions","emailOptions"],b=this.getValue(),c=a.definition.getContents("upload");c=c&&c.hidden;if(b=="url"){r.config.linkShowTargetTab&&a.showPage("target");c||a.showPage("upload")}else{a.hidePage("target");c||a.hidePage("upload")}for(c=0;c<e.length;c++){var d=a.getContentElement("info",e[c]);if(d){d=d.getElement().getParent().getParent();e[c]==b+"Options"?d.show():d.hide()}}a.layout()},
setup:function(a){a.type&&this.setValue(a.type)},commit:function(a){a.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:k.protocol,"default":"http://",items:[["http://\u200e","http://"],["https://\u200e","https://"],["ftp://\u200e","ftp://"],["news://\u200e","news://"],[g.other,""]],setup:function(a){if(a.url)this.setValue(a.url.protocol||"")},commit:function(a){if(!a.url)a.url={};a.url.protocol=this.getValue()}},
{type:"text",id:"url",label:k.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var a=this.getDialog().getContentElement("info","protocol"),e=this.getValue(),b=/^((javascript:)|[#\/\.\?])/i,c=/^(http|https|ftp|news):\/\/(?=.)/i.exec(e);if(c){this.setValue(e.substr(c[0].length));a.setValue(c[0].toLowerCase())}else b.test(e)&&a.setValue("");this.allowOnChange=true},onChange:function(){this.allowOnChange&&this.onKeyUp()},validate:function(){var a=
this.getDialog();if(a.getContentElement("info","linkType")&&a.getValueOf("info","linkType")!="url")return true;if(this.getDialog().fakeObj)return true;return CKEDITOR.dialog.validate.notEmpty(g.noUrl).apply(this)},setup:function(a){this.allowOnChange=false;a.url&&this.setValue(a.url.url);this.allowOnChange=true},commit:function(a){this.onChange();if(!a.url)a.url={};a.url.url=this.getValue();this.allowOnChange=false}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().show()}},
{id:"feindura_link",type:"select",label:feindura_langFile.CKEDITOR_TITLE_LINKS,"default":"",items:feindura_pages,onShow:function(){feindura_pages.each(function(a){var e=a[1].substring(a[1].indexOf("?")).toLowerCase(),b=this.getDialog().getContentElement("info","url").getValue().substring(this.getDialog().getContentElement("info","url").getValue().indexOf("?")).toLowerCase();e==b&&this.setValue(a[1])},this)},onChange:function(){this.getDialog().getContentElement("info","url").setValue(this.getValue())}},
{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:k.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:g.selectAnchor,setup:function(a){a.anchors.length>0?this.getElement().show():this.getElement().hide()},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:g.anchorName,style:"width: 100%;",items:[[""]],setup:function(a){this.clear();this.add("");
for(var e=0;e<a.anchors.length;e++)a.anchors[e].name&&this.add(a.anchors[e].name);a.anchor&&this.setValue(a.anchor.name);(a=this.getDialog().getContentElement("info","linkType"))&&a.getValue()=="email"&&this.focus()},commit:function(a){if(!a.anchor)a.anchor={};a.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:g.anchorId,style:"width: 100%;",items:[[""]],setup:function(a){this.clear();this.add("");for(var e=0;e<a.anchors.length;e++)a.anchors[e].id&&this.add(a.anchors[e].id);
a.anchor&&this.setValue(a.anchor.id)},commit:function(a){if(!a.anchor)a.anchor={};a.anchor.id=this.getValue()}}],setup:function(a){a.anchors.length>0?this.getElement().show():this.getElement().hide()}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="note" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(g.noAnchors)+"</div>",focus:true,setup:function(a){a.anchors.length<1?this.getElement().show():this.getElement().hide()}}],setup:function(){this.getDialog().getContentElement("info",
"linkType")||this.getElement().hide()}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:g.emailAddress,required:true,validate:function(){var a=this.getDialog();if(!a.getContentElement("info","linkType")||a.getValueOf("info","linkType")!="email")return true;return CKEDITOR.dialog.validate.notEmpty(g.noEmail).apply(this)},setup:function(a){a.email&&this.setValue(a.email.address);(a=this.getDialog().getContentElement("info","linkType"))&&a.getValue()=="email"&&
this.select()},commit:function(a){if(!a.email)a.email={};a.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:g.emailSubject,setup:function(a){a.email&&this.setValue(a.email.subject)},commit:function(a){if(!a.email)a.email={};a.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:g.emailBody,rows:3,"default":"",setup:function(a){a.email&&this.setValue(a.email.body)},commit:function(a){if(!a.email)a.email={};a.email.body=this.getValue()}}],setup:function(){this.getDialog().getContentElement("info",
"linkType")||this.getElement().hide()}}]},{id:"target",label:g.target,title:g.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:k.target,"default":"notSet",style:"width : 100%;",items:[[k.notSet,"notSet"],[g.targetFrame,"frame"],[g.targetPopup,"popup"],[k.targetNew,"_blank"],[k.targetTop,"_top"],[k.targetSelf,"_self"],[k.targetParent,"_parent"]],onChange:z,setup:function(a){if(a.target)this.setValue(a.target.type||"notSet");z.call(this)},commit:function(a){if(!a.target)a.target=
{};a.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:g.targetFrameName,"default":"",setup:function(a){a.target&&this.setValue(a.target.name)},commit:function(a){if(!a.target)a.target={};a.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:"100%",align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:g.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:g.popupResizable,setup:n,commit:p},{type:"checkbox",
id:"status",label:g.popupStatusBar,setup:n,commit:p}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:g.popupLocationBar,setup:n,commit:p},{type:"checkbox",id:"toolbar",label:g.popupToolbar,setup:n,commit:p}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:g.popupMenuBar,setup:n,commit:p},{type:"checkbox",id:"fullscreen",label:g.popupFullScreen,setup:n,commit:p}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:g.popupScrollBars,setup:n,commit:p},{type:"checkbox",
id:"dependent",label:g.popupDependent,setup:n,commit:p}]},{type:"hbox",children:[{type:"text",widths:["50%","50%"],labelLayout:"horizontal",label:k.width,id:"width",setup:n,commit:p},{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:g.popupLeft,id:"left",setup:n,commit:p}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:k.height,id:"height",setup:n,commit:p},{type:"text",labelLayout:"horizontal",label:g.popupTop,widths:["50%","50%"],id:"top",
setup:n,commit:p}]}]}]}]},{id:"upload",label:g.upload,title:g.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:k.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:k.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:g.advanced,title:g.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",label:g.id,setup:o,commit:q},{type:"select",
id:"advLangDir",label:g.langDir,"default":"",style:"width:110px",items:[[k.notSet,""],[g.langDirLTR,"ltr"],[g.langDirRTL,"rtl"]],setup:o,commit:q},{type:"text",id:"advAccessKey",width:"80px",label:g.acccessKey,maxLength:1,setup:o,commit:q}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:g.name,id:"advName",setup:o,commit:q},{type:"text",label:g.langCode,id:"advLangCode",width:"110px","default":"",setup:o,commit:q},{type:"text",label:g.tabIndex,id:"advTabIndex",width:"80px",
maxLength:5,setup:o,commit:q}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:g.advisoryTitle,"default":"",id:"advTitle",setup:o,commit:q},{type:"text",label:g.advisoryContentType,"default":"",id:"advContentType",setup:o,commit:q}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:g.cssClasses,"default":"",id:"advCSSClasses",setup:o,commit:q},{type:"text",label:g.charset,"default":"",id:"advCharset",setup:o,commit:q}]},{type:"hbox",
widths:["45%","55%"],children:[{type:"text",label:g.rel,"default":"",id:"advRel",setup:o,commit:q},{type:"text",label:g.styles,"default":"",id:"advStyles",validate:CKEDITOR.dialog.validate.inlineStyle(r.lang.common.invalidInlineStyle),setup:o,commit:q}]}]}]}],onShow:function(){var a=this.getParentEditor(),e=a.getSelection(),b=null;if((b=D.getSelectedLink(a))&&b.hasAttribute("href"))e.selectElement(b);else b=null;this.setupContent(P.apply(this,[a,b]))},onOk:function(){var a={},e=[],b={},c=this.getParentEditor();
this.commitContent(b);switch(b.type||"url"){case "url":var d=b.url&&b.url.protocol!=undefined?b.url.protocol:"http://",f=b.url&&CKEDITOR.tools.trim(b.url.url)||"";a["data-cke-saved-href"]=f.indexOf("/")===0?f:d+f;break;case "anchor":d=b.anchor&&b.anchor.id;a["data-cke-saved-href"]="#"+(b.anchor&&b.anchor.name||d||"");break;case "email":var h=b.email;d=h.address;switch(t){case "":case "encode":f=encodeURIComponent(h.subject||"");var i=encodeURIComponent(h.body||"");h=[];f&&h.push("subject="+f);i&&
h.push("body="+i);h=h.length?"?"+h.join("&"):"";if(t=="encode"){d=["javascript:void(location.href='mailto:'+",B(d)];h&&d.push("+'",y(h),"'");d.push(")")}else d=["mailto:",d,h];break;default:d=d.split("@",2);h.name=d[0];h.domain=d[1];d=["javascript:",A(h)]}a["data-cke-saved-href"]=d.join("")}if(b.target)if(b.target.type=="popup"){d=["window.open(this.href, '",b.target.name||"","', '"];var j=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"];f=j.length;h=function(l){b.target[l]&&
j.push(l+"="+b.target[l])};for(i=0;i<f;i++)j[i]+=b.target[j[i]]?"=yes":"=no";h("width");h("left");h("height");h("top");d.push(j.join(","),"'); return false;");a["data-cke-pa-onclick"]=d.join("");e.push("target")}else{if(b.target.type!="notSet"&&b.target.name)a.target=b.target.name;else e.push("target");e.push("data-cke-pa-onclick","onclick")}if(b.adv){d=function(l,m){var u=b.adv[l];if(u)a[m]=u;else e.push(m)};d("advId","id");d("advLangDir","dir");d("advAccessKey","accessKey");if(b.adv.advName)a.name=
a["data-cke-saved-name"]=b.adv.advName;else e=e.concat(["data-cke-saved-name","name"]);d("advLangCode","lang");d("advTabIndex","tabindex");d("advTitle","title");d("advContentType","type");d("advCSSClasses","class");d("advCharset","charset");d("advStyles","style");d("advRel","rel")}d=c.getSelection();a.href=a["data-cke-saved-href"];if(this._.selectedElement){c=this._.selectedElement;f=c.data("cke-saved-href");h=c.getHtml();c.setAttributes(a);c.removeAttributes(e);if(b.adv&&b.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector)c.addClass(c.getChildCount()?
"cke_anchor":"cke_anchor_empty");if(f==h||b.type=="email"&&h.indexOf("@")!=-1)c.setHtml(b.type=="email"?b.email.address:a["data-cke-saved-href"]);d.selectElement(c);delete this._.selectedElement}else{f=d.getRanges(true);if(f.length==1&&f[0].collapsed){h=new CKEDITOR.dom.text(b.type=="email"?b.email.address:a["data-cke-saved-href"],c.document);f[0].insertNode(h);f[0].selectNodeContents(h);d.selectRanges(f)}d=new CKEDITOR.style({element:"a",attributes:a});d.type=CKEDITOR.STYLE_INLINE;d.apply(c.document)}},
onLoad:function(){r.config.linkShowAdvancedTab||this.hidePage("advanced");r.config.linkShowTargetTab||this.hidePage("target")},onFocus:function(){var a=this.getContentElement("info","linkType");if(a&&a.getValue()=="url"){a=this.getContentElement("info","url");a.select()}}}});
